## 软件逆向工程

动态逆向分析

在一个调试器或调试工具中加载程序，然后一边运行程序一边对程序的行为进行观察和分析



静态逆向分析

执行代码而是使用反编译、反汇编工具，把程序的二进制代码翻译成汇编语言



动静结合



软件逆向的分析方法

1）文件装载：读入目标文件并进行与目标文件相关的一些初步分析，如分析出文件执行的入口地址

2）指令解码：根据目标体系结构的指令编码规则，对目标文件中使用的指令进行解释、识别和翻译。可以将目标指令映射为汇编指令，也可以映射为某种中间表示形式。

3）语义映射：将二进制指令的执行效果通过语义描述的方法表示出来，并加以记录。由于指令的执行语义往往保存在与体系结构相关的文献资料中，因此该映射过程需要技术人员手工实现。

4）相关图构造：借助于编译理论中的许多知识完成相关图构造，如控制流图、调用图和依赖图 等。

5）过程分析：经过编译器翻译后的程序大多是面向过程的，即使对于面向对象语言生成的可执行程序来说，编译器依然通过相关技术将其翻译为过程式代码。过程分析阶段的主要目标就是将目标文件中的过程信息恢复出来，包括过程边界分析、过程名(可能并不存在)、参数列表和返回值信息。

6）类型分析：本阶段的目标在于，正确反映原程序中各个存储单元(包括寄存器和内存)所携带的类型信息。

7）结果输出：将分析结果有效地呈现在分析人员面前。例如，输出结果是以某种高级语言为载体的程序代码，这样容易被人理解，通过简单的修改便可以应用在其他软件系统中。

### 相关工具

OllyDbg

IDA



## 面向恶意代码检测的软件可信验证

软件可信验证模型FICE

#### 特征可信验证

- 1、特征码扫描
  - 病毒特征码是某个恶意软件样本常见的连续字节序列。这意味着含有特征码在恶意软件或受感染文件内，而在未受感染的文件里则不会找到。
  - 首先提取新恶意软件的独有特征指令序列，并将其更新至病毒特征码库，在检测时将当前文件与特征库进行对比，判断是否存在某一文件片段与已知样本相吻合
  - 优点是判断准确率高、误报率低。该验证方法无法检测未知的恶意代码
- 2、完整性验证
  - 首先计算正常文件的哈希值（校验和），并将其保存起来，当需要验证该文件的可信性时，再次计算其哈希值，并与之前保存起来的值比较
  - 不依赖外部信息，既可以用来检测已知病毒，也可以检测未知病毒。但缺点是**滞后性**，感染发生后才可以验证其可信性。另外文件内容变化原因多，容易误报。需要维护庞大的正常文件哈希值库。
- 污点跟踪技术
  - 用于识别和跟踪应用程序中的输入和输出数据，以及与其相关联的敏感信息，检测这些数据在整个处理过程中是否被篡改污染。

[关于污点跟踪](https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/5.5_taint_analysis.html)



#### 身份（来源）可信验证

代码签名技术可以用来进行代码来源（身份）可信性的判断，即通过软件附带的数字证书进行合法性、完整性的验证，以免受恶意软件的侵害。

从用户角度，可以通过代码签名服务鉴别软件的发布者及软件在传输过程中是否被篡改。如果某软件在用户计算机上执行后造成恶性后果，由于代码签名服务的可审计性，用户可依法向软件发布者索取赔偿，将很好的制止软件开发者发布攻击性代码的行为。



#### 能力（行为）可信验证

1、静态行为分析



2、动态行为分析

（1）系统状态建模法

该方法的基本思想是首先在一个虚拟环境中运行待验证软件，记录软件运行时的系统资源消耗情况，建立系统状态模型，从中发现该软件的异常行为，进而验证其可信性。     

一般情况下，可采用程序运行时的系统资源消耗情况来衡量程序的性能状态，而CPU、 内存和磁盘输入/输出等是最关键的系统资源。

（2）系统关键位置监测法

系统关键位置监测法借助于虚拟环境，通过对系统的一些关键位置进行全方位、多角度的实时监测，捕获软件在安装、启动和运行时的多种行为特征，然后结合机器学习等方面的技术，利用程序行为样本库中的样本行为对训练模块进行训练，提取出规则、知识，从而使验证模块能够对检测到的软件行为做出自动化评定，区分出可信软件和危险软件。

（3）内核状态监测法

系统内核负责一切实际工作，包括CPU 任务调度、内存分配管理、设备管理和文件操作等，因此如果内核变得不可信，那么任何其他的信息都将不可信。

内核状态检测方法包括系统守护、内存扫描、查找钩子、基于行为的检测方法等。



#### 运行环境可信验证

虚拟化恶意软件是指，在支持虚拟化功能的CPU 上运行操作系统，即在目标系统和硬件层之间插入虚拟机监视器 (Virtual Machine Monitor,VMM),使目标系统运行在虚拟机监控器之上，并受其完全控制。

一种名为虚拟机Rootkit(Virtual-Machine Based Rootkit,VMBR) 的实验室恶意软件，对系统具有更高的控制程度，能够提供多方面的功能，并且其状态和活动对运行在原有系统中的安全检测程序来说是不可见的。 VMBR 在正在运行的操作系统下安装一个虚拟机监视器VMM, 并将这个原有操作系统迁移到虚拟机里，而原有系统中的软件无法访问到它们的状态，因此VMBR 很难被检测和移除。

 Blue pill是一个基于硬件虚拟化的rootkit。名字包含了黑客帝国里蓝色药丸的含义，生活在一个虚拟的世界里而不自知。Blue pill背后的思路：操作系统“吞下”Blue pill，在Blue pill控制的空间里（原文用的是Matrix）被唤醒。这个过程是即时的（不需要重启），没有性能损失，所有设备完全可以访问操作系统（实际在虚拟机中运行的）。