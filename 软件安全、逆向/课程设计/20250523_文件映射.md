CreateFileMapping , OpenFileMapping, MapViewOfFile, UnmapViewofFile  解释



OpenFileMappingW

### 什么是**命名共享内存对象**（也称**文件映射对象** File Mapping Object）？

文件映射对象是 Windows 内核提供的一种机制，它允许你将一个**文件（或一部分文件）的内容**直接映射到进程的虚拟地址空间中。一旦映射完成，你就可以像访问普通内存一样直接读写这个文件的数据。

更进一步地，当这个对象被“命名”后，它就成为了实现**进程间通信 (IPC) 中共享内存**的主要手段。



文件映射对象这个名字可能有些误导，因为它不仅仅用于映射实际的磁盘文件。它有两个主要用途：

1. **映射现有文件内容**：将一个磁盘文件（例如一个文本文件、数据库文件）的内容映射到内存中。这样做的好处是你可以像操作内存数组一样修改文件，系统会自动处理数据的读写和同步到磁盘。这实现了**内存映射文件**的功能，可以用于大文件的快速随机访问。
2. **创建内存支持的共享内存（也即“命名共享内存对象”）**：如果你在 `CreateFileMapping` 函数中，将文件句柄指定为 `INVALID_HANDLE_VALUE`，那么你实际上并不是在映射一个物理文件，而是在系统页文件（或者说，**虚拟内存**）中创建了一块连续的内存区域，并为其赋予了一个名称。这块内存区域就是我们所说的**命名共享内存**。



### 命名共享内存对象的核心概念

1. **内核对象**：它是一个由操作系统内核维护的对象。当你创建它时，内核会分配一块内存区域（通常在系统分页文件或物理内存中），并为它分配一个唯一的名称。
2. **“命名”的意义**：这个“名称”（例如 `L"MySharedDataRegion"`) 允许**不同的进程**通过这个唯一的名称来找到并引用同一个共享内存区域。这是实现进程间通信的关键。
3. “共享内存”的实现：当多个进程都“映射”了这个命名文件映射对象（即调用 MapViewOfFile），系统会把这块共享的物理内存区域分别映射到每个进程自己的虚拟地址空间中。虽然每个进程看到的虚拟地址可能不同，但它们都指向了相同的物理内存。
   - 进程 A 在其虚拟地址 `0x10000000` 处修改了一个字节。
   - 进程 B 在其虚拟地址 `0x20000000` 处（这个地址也指向同一块物理内存）立即能看到这个修改。
   - 这就是“共享”的含义：所有访问它的进程都能看到并操作同样的数据。



### 使用命名共享内存对象的关键步骤

1. 创建或打开文件映射对象：
   - 使用 `CreateFileMappingW` 函数。
     - 若要创建**内存支持的共享内存** (即命名共享内存对象)，将第一个参数 `hFile` 设为 `INVALID_HANDLE_VALUE`。
     - `lpName` 参数指定共享内存的名称。
     - `dwMaximumSizeHigh` 和 `dwMaximumSizeLow` 指定共享内存的总大小。
   - 或者使用 `OpenFileMappingW` 函数来打开一个已经存在的命名文件映射对象。
2. 映射视图 (Map View)：
   - 使用 `MapViewOfFile` 函数。
   - 将文件映射对象的一部分或全部映射到当前进程的虚拟地址空间中。
   - 函数返回一个 `LPVOID` 类型的指针，指向映射区域的起始地址。
3. 读写数据：
   - 获得映射指针后，可以直接像操作普通指针一样读写这块内存。例如：`memcpy(pSharedBuffer, &myData, sizeof(myData));`
4. 解除映射 (Unmap View)：
   - 当不再需要访问共享内存时，使用 `UnmapViewOfFile` 函数解除映射。这会释放进程地址空间中对应的虚拟内存区域。
5. 关闭句柄 (Close Handle)：
   - 当所有进程都不再需要共享内存时，使用 `CloseHandle` 函数关闭文件映射对象的句柄。这会递减内核对象的引用计数，当引用计数降为零时，系统会销毁该共享内存区域。