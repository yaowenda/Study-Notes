建表

```sql
CREATE TABLE `data_change_log` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `username` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL COMMENT '操作人用户名',
  `user_id` bigint DEFAULT NULL COMMENT '操作人ID',
  `table_name` varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL COMMENT '操作的表名',
  `record_id` varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL COMMENT '主键值',
  `operation_type` varchar(10) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL COMMENT '操作类型（INSERT / UPDATE / DELETE）',
  `sql_text` text CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci COMMENT '原始SQL或变更内容（如JSON）',
  `create_time` datetime DEFAULT NULL COMMENT '操作时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=16 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
```



ruoyi-common/src/main/java/com/ruoyi/common/annotation/DataChangeLog.java

```java
package com.ruoyi.common.annotation;

import java.lang.annotation.*;

@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface DataChangeLog {
    String table();         // 表名
    String type();          // 操作类型：insert/update/delete
}

```

ruoyi-framework/src/main/java/com/ruoyi/framework/aspectj/DataChangeLogAspect.java

```java
package com.ruoyi.framework.aspectj;

import com.alibaba.fastjson2.JSON;
import com.ruoyi.account.service.IAccountInfoService;
import com.ruoyi.address.service.IClientAddressService;
import com.ruoyi.administration.service.IAdministrationDataService;
import com.ruoyi.catalogItem.service.ICatalogItemsService;
import com.ruoyi.category.service.IDirectoryCategoryService;
import com.ruoyi.classification.service.ICommodityClassificationService;
import com.ruoyi.client.service.IClientTypeService;
import com.ruoyi.clientInfo.service.IClientInfoService;
import com.ruoyi.common.annotation.DataChangeLog;
import com.ruoyi.common.annotation.PrimaryKeyField;
import com.ruoyi.common.core.domain.entity.SysUser;
import com.ruoyi.common.utils.DataCompareUtil;
import com.ruoyi.common.utils.SecurityUtils;
import com.ruoyi.connection.service.IClientConnectionService;
import com.ruoyi.framework.web.domain.server.Sys;
import com.ruoyi.info.service.ICommodityInfoService;
import com.ruoyi.infoChild.service.ICommodityInfoChildService;
import com.ruoyi.log.domain.DataChangeLogEntity;
import com.ruoyi.log.mapper.DataChangeLogMapper;
import com.ruoyi.system.service.ISysUserService;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import javax.servlet.http.HttpServletRequest;
import java.lang.reflect.Field;
import java.util.Date;


@Aspect
@Component
public class DataChangeLogAspect {

    @Autowired
    private HttpServletRequest request;

    @Autowired
    private ISysUserService userService;

    @Autowired
    private DataChangeLogMapper dataChangeLogMapper;

    @Autowired
    private ICommodityClassificationService commodityClassificationService;

    @Autowired
    private ICatalogItemsService catalogItemsService;
    @Autowired
    private IDirectoryCategoryService directoryCategoryService;
    @Autowired
    private IAdministrationDataService administrationDataService;
    @Autowired
    private ICommodityInfoService commodityInfoService;
    @Autowired
    private ICommodityInfoChildService commodityInfoChildService;
    @Autowired
    private IClientTypeService clientTypeService;
    @Autowired
    private IClientInfoService clientInfoService;
    @Autowired
    private IAccountInfoService accountInfoService;
    @Autowired
    private IClientAddressService clientAddressService;
    @Autowired
    private IClientConnectionService clientConnectionService;

    @Around("@annotation(dataChangeLog)")
    public Object logDataChange(ProceedingJoinPoint joinPoint, DataChangeLog dataChangeLog) throws Throwable {
        Object[] args = joinPoint.getArgs();
        Object param = args.length > 0 ? args[0] : null;

        String table = dataChangeLog.table();
        String type = dataChangeLog.type();

        SysUser user = SecurityUtils.getLoginUser().getUser();

        // ① 如果是 update 或 delete，先查询修改前的数据
        Object beforeData = null;
        if ("update".equalsIgnoreCase(type) || "delete".equalsIgnoreCase(type)) {
            // 你需要自己实现这部分，例如通过 ID 查询旧数据
            Long id = (Long)extractIdFromParam(param); // 假设参数里包含 ID
            beforeData = queryOldData(table, id);
        }

        // ② 执行业务逻辑
        Object result = joinPoint.proceed();

        // ③ 记录日志（对比前后数据）
        Object afterData = null;
        if ("update".equalsIgnoreCase(type)) {
            afterData = param; // 修改后的数据就是传参
        } else if ("insert".equalsIgnoreCase(type)) {
            afterData = param; // 新增就是本身
        }

        DataChangeLogEntity log = new DataChangeLogEntity();
        log.setUsername(user.getUserName());
        log.setUserId(user.getUserId());
        log.setTableName(table);
        log.setOperationType(type.toUpperCase());
        log.setCreateTime(new Date());

        // 字段级差异对比（你需要实现这个工具类）
        String diff = DataCompareUtil.compare(beforeData, afterData);
        log.setSqlText(diff);

        dataChangeLogMapper.insertDataChangeLog(log);

        return result;
    }

    public Object extractIdFromParam(Object param) {
        if (param == null) {
            return null;
        }

        // 单个实体参数
        if (!isPrimitiveOrWrapper(param.getClass())) {
            for (Field field : param.getClass().getDeclaredFields()) {
                if (field.isAnnotationPresent(PrimaryKeyField.class)) {
                    field.setAccessible(true);
                    try {
                        return field.get(param);
                    } catch (IllegalAccessException e) {
                        e.printStackTrace();
                    }
                }
            }
        }

        return null;
    }

    // 判断是否是基本类型或包装类
    private boolean isPrimitiveOrWrapper(Class<?> clazz) {
        return clazz.isPrimitive() ||
                clazz == Long.class ||
                clazz == Integer.class ||
                clazz == String.class ||
                clazz == Double.class ||
                clazz == Float.class ||
                clazz == Boolean.class;
    }

    private Object queryOldData(String table, Long id) {
        switch (table) {
            case "目录":
                return catalogItemsService.selectCatalogItemsById(id);
            case "目录分类":
                return directoryCategoryService.selectDirectoryCategoryById(id);
            case "基础资料":
                return administrationDataService.selectAdministrationDataByAdministrationId(id);
            case "商品分类":
                return commodityClassificationService.selectCommodityClassificationById(id);
            case "商品信息":
                return commodityInfoService.selectCommodityInfoByCommodityId(id);
            case "多单位子表":
                return commodityInfoChildService.selectCommodityInfoChildByUnitId(id);
            case "客户类型":
                return clientTypeService.selectClientTypeByTypeId(id);
            case "客户信息":
                return clientInfoService.selectClientInfoByClientId(id);
            case "账户信息":
                return accountInfoService.selectAccountInfoByAccountId(id);
            case "联系方式":
                return clientConnectionService.selectClientConnectionByConnectId(id);
            case "客户地址":
                return clientAddressService.selectClientAddressByAddressId(id);
            default:
                return null;
        }
    }
}
```

ruoyi-common/src/main/java/com/ruoyi/common/annotation/PrimaryKeyField.java

```java
package com.ruoyi.common.annotation;

import java.lang.annotation.*;

@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.FIELD)
public @interface PrimaryKeyField {
}
```

ruoyi-common/src/main/java/com/ruoyi/common/utils/DataCompareUtil.java

```java
package com.ruoyi.common.utils;

import com.alibaba.fastjson2.JSON;

import java.lang.reflect.Field;

public class DataCompareUtil {

    public static String compare(Object oldObj, Object newObj) {
        if (oldObj == null && newObj != null) {
            return JSON.toJSONString(newObj);
        } else if (oldObj != null && newObj == null) {
            return JSON.toJSONString(oldObj);
        } else if (oldObj != null) {
            StringBuilder sb = new StringBuilder("修改记录：\n");
            try {
                Field[] fields = oldObj.getClass().getDeclaredFields();
                for (Field field : fields) {
                    field.setAccessible(true);
                    Object oldValue = field.get(oldObj);
                    Object newValue = field.get(newObj);

                    if (oldValue == null && newValue == null) continue;
                    if (oldValue == null || newValue == null || !oldValue.equals(newValue)) {
                        sb.append(String.format("字段 [%s]：%s -> %s\n",
                                field.getName(), String.valueOf(oldValue), String.valueOf(newValue)));
                    }
                }
            } catch (Exception e) {
                return "字段比对失败：" + e.getMessage();
            }
            return sb.toString();
        } else {
            return "无变更";
        }
    }
}


```

在实体类标明主键：

```java
    /** ID */
    @PrimaryKeyField
    private Long commodityId;

```

在服务类实现中，使用对应的注解

```java
@DataChangeLog(table = "商品信息", type = "insert")
    @Override
    public int insertCommodityInfo(CommodityInfo commodityInfo)
    {
```

