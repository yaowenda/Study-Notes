```vue

<el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="图片" prop="picture">
              <el-upload class="upload-demo" :headers="uploadHeaders" :action="uploadUrl" list-type="picture-card"
                accept="image/*" name="files" :file-list="imageFileList" :on-success="handleImageSuccess" :on-remove="handleImageRemove" multiple>
                <i class="el-icon-plus"></i>
              </el-upload>

              <!-- 使用 viewer.js 预览 -->
              <div v-if="form.picture && form.picture.length" ref="viewerContainer">
                <img v-for="(url, index) in form.picture" :key="index" :src="baseUrl + url"
                  style="width: 100px; height: 100px; margin-right: 10px; cursor: pointer;"
                  @click="openViewer(index)" />
              </div>
            </el-form-item>
          </el-col>

          <el-col :span="12">
            <el-form-item label="视频" prop="video">
              <el-upload :headers="uploadHeaders" :action="uploadUrl" accept=".mp4" name="files" :show-file-list="false"
                :on-success="handleVideoSuccess" :before-upload="beforeUploadVideo">
                <el-button icon="el-icon-upload">上传视频</el-button>
              </el-upload>

              <!-- 播放区 -->
              <div v-if="form.video.length > 0" class="video-player-container" style="display:flex; margin-top:10px;">
                <!-- 左侧播放器 -->
                <div style="flex:2; margin-right:20px;">
                  <video id="video-player" class="video-js vjs-default-skin" controls preload="auto" width="400"
                    height="240"></video>
                </div>

                <!-- 右侧视频列表 -->
                <div style="flex:1; display:flex; flex-direction:column;">
                  <div v-for="(url, index) in form.video" :key="index" @click="playVideo(index)" :style="{
                    cursor: 'pointer',
                    marginBottom: '8px',
                    border: '1px solid #eee',
                    padding: '6px',
                    borderRadius: '5px',
                    background: index === currentIndex ? '#ecf5ff' : '#fff'
                  }">
                    {{ getFileName(url) }}
                  </div>
                  <el-button type="text" icon="el-icon-delete" @click.stop="removeVideo(index)" />
                </div>
              </div>
            </el-form-item>
          </el-col>
        </el-row>
```

```js
import Viewer from 'viewerjs'
import 'viewerjs/dist/viewer.css'
import videojs from 'video.js'
import 'video.js/dist/video-js.css'
import playlist from "videojs-playlist";
import { getToken } from "@/utils/auth";

// 注册 videojs-playlist 插件
// 确保只注册一次，可以在 main.js 或组件顶部执行
if (videojs.getPlugin('playlist') === undefined) {
  videojs.registerPlugin("playlist", playlist);
}

export default {
  name: "Allot",
  dicts: ['out_warehouse_approval', 'allot_doc_status', 'in_warehouse_approval'],
  components: { Viewer, videojs, playlist },
  data() {
    return {
      uploadUrl: process.env.VUE_APP_BASE_API + "/common/uploads",
      baseUrl: "", // 文件访问前缀
      uploadHeaders: { Authorization: "Bearer " + getToken() },
      viewer: null,
      player: null,
      currentIndex: 0, // 当前播放视频索引
      imageFileList: [], // el-upload 用于显示图片的文件列表
      videoFileList: [], // 视频文件列表
```



```js
beforeDestroy() {
    // 组件销毁时，销毁播放器，防止内存泄漏
    if (this.player && !this.player.isDisposed()) {
      this.player.dispose();
    }
  },
  methods: {
    /** ========== 图片相关 ========== */
    handleImageSuccess(response) {
      if (response.code === 200 && response.fileNames) {
        const uploadedUrls = response.fileNames.split(",").filter(u => u.trim());
        this.form.picture.push(...uploadedUrls);
        this.$nextTick(() => this.initViewer());
      } else {
        this.$message.error("图片上传失败");
      }
    },
    handleImageRemove(file) {
      // const index = this.form.picture.indexOf(file.url);
      // if (index !== -1) this.form.picture.splice(index, 1);
      // file.url 可能是完整路径，因此需要提取后缀部分匹配
      const relativeUrl = file.url.replace(this.baseUrl, "");
      this.form.picture = this.form.picture.filter(item => item !== relativeUrl);
      this.imageFileList = this.imageFileList.filter(item => item.url !== file.url);
    },
    initViewer() {
      if (this.viewer) this.viewer.destroy();
      this.viewer = new Viewer(this.$refs.viewerContainer, {
        toolbar: true,
        title: false,
      });
    },
    openViewer(index) {
      if (this.viewer) this.viewer.view(index);
    },

    /** ========== 视频相关 ========== */
    removeVideo(index) {
      this.form.video.splice(index, 1);
      if (this.player && !this.player.isDisposed()) {
        this.initOrUpdatePlayer(); // 重建播放列表
      }
	}
    beforeUploadVideo(file) {
      const isMp4 = file.type === "video/mp4";
      if (!isMp4) {
        this.$message.error("仅支持 MP4 格式");
        return false;
      }
      return true;
    },

    handleVideoSuccess(response) {
      if (response.code === 200 && response.fileNames) {
        const uploadedUrls = response.fileNames.split(",").filter(u => u.trim());
        // Ruoyi-Vue返回的通常是 /profile/upload/... 这样的路径，需要拼接
        const fullUrls = uploadedUrls.map(url => this.baseUrl + url);

        // 使用 this.form.video.push(...fullUrls); 
        // 这里假设你的form.video存储的是完整URL
        this.form.video.push(...uploadedUrls);


        this.$message.success("视频上传成功");

        this.$nextTick(() => {
          this.initOrUpdatePlayer();
        });
      } else {
        console.error("上传返回：", response);
        this.$message.error(response.msg || "视频上传失败");
      }
    },

    initOrUpdatePlayer() {
      // 构造播放列表
      const playlist = this.form.video.map(url => ({
        sources: [{ src: this.baseUrl + url, type: "video/mp4" }],
        poster: "" // 可选的视频封面
      }));

      // 如果播放器已存在且未被销毁，则只更新播放列表
      if (this.player && !this.player.isDisposed()) {
        this.player.playlist(playlist);
        // 切换到最新上传的视频并播放
        const newIndex = playlist.length - 1;
        this.player.playlist.currentItem(newIndex);
        this.player.play();
        this.currentIndex = newIndex;
      } else {
        // 否则，初始化一个新的播放器
        const videoEl = document.getElementById("video-player");
        if (!videoEl) {
          console.error("找不到 video-player 元素");
          return;
        }

        this.player = videojs(videoEl, {
          controls: true,
          preload: "auto",
        });

        this.player.playlist(playlist);

        // 默认播放第一个
        this.player.playlist.currentItem(0);
        this.player.play();
        this.currentIndex = 0;

        // 绑定事件监听，只在初始化时绑定一次
        this.player.on("playlistitem", () => {
          this.currentIndex = this.player.playlist.currentItem();
        });
      }
    },

    playVideo(index) {
      if (this.player && !this.player.isDisposed()) {
        this.player.playlist.currentItem(index);
        this.player.play();
        this.currentIndex = index;
      }
    },

    getFileName(path) {
      if (!path) return '';
      // 如果已经是完整URL，需要从中提取文件名
      try {
        const url = new URL(path);
        const parts = url.pathname.split("/");
        return parts[parts.length - 1];
      } catch (e) {
        // 如果不是完整的URL，则按原逻辑处理
        const parts = path.split("/");
        return parts[parts.length - 1];
      }
    },
```

```js
// 表单重置
    reset() {
      this.form = {
        allotId: null,
        allotNumber: null,
        outWarehouseEncoding: null,
        inWarehouseEncoding: null,
        docStatus: null,
        outWarehouseStatus: null,
        inWarehouseStatus: null,
        remark: null,
        createdBy: null,
        createdAt: null,
        updatedBy: null,
        updatedAt: null,
        delFlag: null,
        picture: [], ////////
        video: [],
        allotDetailList: []
      };
      this.imageFileList = []; //  同步清空
  	  this.videoFileList = []; //  同步清空
      this.resetForm("form");
      this.handleDialogClose(); //清理回调
    },
    /**
   * 弹窗开启时的清理回调
   */
    handleDialogClose() {
      // 销毁 video.js 播放器
      if (this.player && !this.player.isDisposed()) {
        this.player.dispose();
      }
      this.player = null; // 关键：必须重置为 null

      // 销毁 viewer.js 预览器
      // 同样的问题也会发生在图片预览上，所以一并处理
      if (this.viewer) {
        this.viewer.destroy();
        this.viewer = null; // 关键：必须重置为 null
      }
    },
```



```js
/** 修改按钮操作 */
    handleUpdate(row) {
      this.reset();
      const allotId = row.allotId || this.ids
      getAllot(allotId).then(response => {
        this.form = response.data;
        // ----- 关键修改：将 video 字符串转换为数组 -----
        if (this.form.video && typeof this.form.video === 'string') {
          // 使用 split 将字符串按逗号分割，并用 filter 移除可能存在的空字符串（例如由末尾逗号导致）
          this.form.video = this.form.video.split(',').filter(item => item.trim() !== '');
        } else {
          // 如果 video 字段为 null 或不是字符串，确保它是一个空数组，以避免 v-for 报错
          this.form.video = [];
        }
          
        this.videoFileList = this.form.video.map((url, index) => ({
          name: this.getFileName(url),
          url: this.baseUrl + url,
        }));

        // ----- 新增：处理 picture 字符串 -----
        if (this.form.picture && typeof this.form.picture === 'string') {
          this.form.picture = this.form.picture.split(',').filter(item => item.trim() !== '');
        } else {
          // 确保 picture 在没有值的情况下也是一个空数组
          this.form.picture = [];
        }
          
        this.imageFileList = this.form.picture.map((url, index) => ({
          name: this.getFileName(url),
          url: this.baseUrl + url,
        }));
        // ------------------------------------


        this.open = true;
        this.title = "修改";
        this.$nextTick(() => {
          // ----- 初始化视频播放器（保留原有逻辑）-----
          if (this.form.video.length > 0) {
            this.initOrUpdatePlayer();
          }

          // ----- 新增：初始化图片预览器 -----
          if (this.form.picture.length > 0) {
            this.initViewer();
          }
          // ------------------------------------
        });
      });
    },
```

```js
/** 提交按钮 */
    submitForm() {
      this.$refs["form"].validate(valid => {
        if (valid) {
          // 检查出库编码和入库编码不能相同
          if (this.form.outWarehouseEncoding === this.form.inWarehouseEncoding) {
            this.$modal.msgError("出库编码和入库编码不能相同");
            return;
          }

          // 先处理 picture 和 video 数组转字符串
          const formData = {
            ...this.form,
            picture: this.form.picture ? this.form.picture.join(",") : "",
            video: this.form.video ? this.form.video.join(",") : ""
          };

          if (this.form.allotId != null) {
            // 修改逻辑
            updateAllot(formData).then(response => {
              this.$modal.msgSuccess("修改成功");
              this.open = false;
              this.getList();
            });
          } else {
            // 新增逻辑：先生成单号，再提交
            this.generateOdd()
              .then(odd => {
                // 将生成的单号赋值到 formData
                formData.allotNumber = odd;

                // 提交新增请求
                return addAllot(formData);
              })
              .then(response => {
                this.$modal.msgSuccess("新增成功");
                this.open = false;
                this.getList();
              })
              .catch(error => {
                console.error("单号生成或提交失败:", error);
                this.$modal.msgError("操作失败，请重试");
              });
          }
        }
      });
    },
```

```css
.video-container {
  display: flex;
  gap: 10px;
}

.video-player {
  flex: 1;
}

.video-list {
  width: 200px;
  overflow-y: auto;
}

.video-item {
  margin-bottom: 10px;
  cursor: pointer;
}

.video-item:hover {
  background-color: #f5f7fa;
}
```

