```sql
CREATE TABLE `purchase_return_sequence` (
  `seq_date` date NOT NULL COMMENT '日期',
  `seq_number` int NOT NULL COMMENT '当天序列号',
  PRIMARY KEY (`seq_date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
```

```sql
<!-- 获取当天流水号（并发安全） -->
    <insert id="getAndUpdateSequence" parameterType="String">
        INSERT INTO application_form_sequence(seq_date, seq_number)
        VALUES (#{formattedDate}, 1)
            ON DUPLICATE KEY UPDATE seq_number = LAST_INSERT_ID(seq_number + 1)
    </insert>

    <!-- 取出刚更新的 seq_number -->
    <select id="getLastInsertId" resultType="int">
        SELECT LAST_INSERT_ID()
    </select>
```

```
    public int getAndUpdateSequence(String formattedDate);
    public int getLastInsertId();
```

然后在需要生成单号的服务层：

```java
@Override
    public int getSequenceNumber(String formattedDate)
    {
        applicationFormSequenceMapper.getAndUpdateSequence(formattedDate);
        return applicationFormSequenceMapper.getLastInsertId();
    }
```

```java
//获取当天已经生成的采购单的数量
    @GetMapping("/getSequenceNumber")
    public Integer getSequenceNumber(){
        Date currentDate = new Date();
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
        String formattedDate = sdf.format(currentDate);
        return applicationFormService.getSequenceNumber(formattedDate);
    }
```

前端：

```js
async generateOdd() {
      const date = new Date();
      const ymd = [
        date.getFullYear(),
        String(date.getMonth() + 1).padStart(2, '0'),
        String(date.getDate()).padStart(2, '0')
      ].join('');
      const sequenceNumber = await getSequenceNumber();
      const nextSequence = (sequenceNumber).toString();
      const paddedSequence = nextSequence.padStart(3, '0'); // 补零成3位
      return `CQ${ymd}${paddedSequence}`;
    },
```

```js
this.$refs["form"].validate(valid => {
        if (valid) {
          if (this.form.appliFormId != null) {
            updateApplication(this.form).then(response => {
              this.$modal.msgSuccess("修改成功");
              this.open = false;
              this.getList();
            });
          } else {
            this.generateOdd().then(odd => {
              this.form.appliFormOdd = odd;
            }).then(() => {
              addApplication(this.form).then(response => {
                this.$modal.msgSuccess("新增成功");
                this.open = false;
                this.getList();
              });
            })

          }
        }
      });
```

